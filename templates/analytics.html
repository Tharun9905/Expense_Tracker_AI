{% extends "base.html" %}
{% block content %}
<h2>Analytics & Insights</h2>

<div class="btn-group mt-3">
    <a href="?period=week" class="btn btn-outline-primary {{ 'active' if period == 'week' }}">Week</a>
    <a href="?period=month" class="btn btn-outline-primary {{ 'active' if period == 'month' }}">Month</a>
    <a href="?period=year" class="btn btn-outline-primary {{ 'active' if period == 'year' }}">Year</a>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card"><div class="card-body text-center">
            <h6>Total Income</h6>
            <h3 class="text-success">{{ format_inr(report.summary.total_income) }}</h3>
        </div></div>
    </div>
    <div class="col-md-4">
        <div class="card"><div class="card-body text-center">
            <h6>Total Expenses</h6>
            <h3 class="text-danger">{{ format_inr(report.summary.total_expense) }}</h3>
        </div></div>
    </div>
    <div class="col-md-4">
        <div class="card"><div class="card-body text-center">
            <h6>Net Savings</h6>
            <h3 class="{{ 'text-success' if report.summary.net_savings >= 0 else 'text-danger' }}">
                {{ format_inr(report.summary.net_savings) }}
            </h3>
        </div></div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><h5>Spending by Category</h5></div>
            <div class="card-body"><canvas id="categoryChart"></canvas></div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><h5>Daily Spending Trend</h5></div>
            <div class="card-body"><canvas id="trendChart"></canvas></div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header"><h5>Top 5 Expenses</h5></div>
            <div class="card-body">
                <table class="table">
                    <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th></tr></thead>
                    <tbody>
                        {% for expense in report.top_expenses %}
                        <tr>
                            <td>{{ expense.date }}</td>
                            <td>{{ expense.category }}</td>
                            <td>{{ expense.description }}</td>
                            <td class="text-danger">{{ format_inr(expense.amount) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const categoryCtx = document.getElementById('categoryChart');
new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: {{ report.category_breakdown | map(attribute='category') | list | tojson }},
        datasets: [{
            data: {{ report.category_breakdown | map(attribute='amount') | list | tojson }},
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
        }]
    }
});

const trendCtx = document.getElementById('trendChart');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: {{ report.daily_spending | map(attribute='date') | list | tojson }},
        datasets: [{
            label: 'Daily Spending',
            data: {{ report.daily_spending | map(attribute='amount') | list | tojson }},
            borderColor: '#FF6384',
            tension: 0.4
        }]
    }
});
</script>
{% endblock %}